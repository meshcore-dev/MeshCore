package com.meshcore.team.ui.components

import android.Manifest
import android.content.pm.PackageManager
import androidx.activity.compose.rememberLauncherForActivityResult
import androidx.activity.result.contract.ActivityResultContracts
import androidx.compose.foundation.layout.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.unit.dp
import androidx.compose.ui.viewinterop.AndroidView
import androidx.core.content.ContextCompat
import com.journeyapps.barcodescanner.BarcodeCallback
import com.journeyapps.barcodescanner.BarcodeResult
import com.journeyapps.barcodescanner.BarcodeView
import com.journeyapps.barcodescanner.DefaultDecoderFactory
import com.google.zxing.BarcodeFormat
import com.google.zxing.DecodeHintType
import timber.log.Timber

/**
 * QR Code Scanner using ZXing library
 * 
 * @param onQrCodeScanned Callback when a valid QR code is detected
 * @param onDismiss Callback to dismiss the scanner
 */
@Composable
fun QrCodeScanner(
    onQrCodeScanned: (String) -> Unit,
    onDismiss: () -> Unit
) {
    val context = LocalContext.current
    var hasCameraPermission by remember {
        mutableStateOf(
            ContextCompat.checkSelfPermission(
                context,
                Manifest.permission.CAMERA
            ) == PackageManager.PERMISSION_GRANTED
        )
    }
    
    val launcher = rememberLauncherForActivityResult(
        contract = ActivityResultContracts.RequestPermission()
    ) { granted ->
        hasCameraPermission = granted
        if (!granted) {
            Timber.w("Camera permission denied")
            onDismiss()
        } else {
            Timber.i("Camera permission granted")
        }
    }
    
    LaunchedEffect(Unit) {
        if (!hasCameraPermission) {
            Timber.i("Requesting camera permission...")
            launcher.launch(Manifest.permission.CAMERA)
        } else {
            Timber.i("Camera permission already granted")
        }
    }
    
    if (hasCameraPermission) {
        Timber.d("Rendering QR scanner view")
        Box(modifier = Modifier.fillMaxSize()) {
            AndroidView(
                factory = { ctx ->
                    Timber.i("Creating BarcodeView directly (no wrapper)...")
                    BarcodeView(ctx).apply {
                        val formats = listOf(BarcodeFormat.QR_CODE)
                        
                        // Create decoder with hints for better QR detection
                        val hints = mapOf(
                            DecodeHintType.TRY_HARDER to true,
                            DecodeHintType.PURE_BARCODE to false,
                            DecodeHintType.CHARACTER_SET to "UTF-8"
                        )
                        decoderFactory = DefaultDecoderFactory(formats, hints, null, 0)
                        Timber.i("Decoder factory set for QR_CODE format with TRY_HARDER hint")
                        
                        // Configure camera settings for better QR detection
                        val settings = cameraSettings
                        settings.isAutoFocusEnabled = true
                        settings.isContinuousFocusEnabled = true
                        settings.isAutoTorchEnabled = false
                        settings.isScanInverted = false
                        settings.isBarcodeSceneModeEnabled = true
                        cameraSettings = settings
                        Timber.i("Camera settings configured: autoFocus=true, continuousFocus=true")
                        
                        // Callback counters
                        var nullResultCount = 0
                        var lastLogTime = System.currentTimeMillis()
                        var callbackInvokedCount = 0
                        
                        val callback = object : BarcodeCallback {
                            override fun barcodeResult(result: BarcodeResult?) {
                                callbackInvokedCount++
                                Timber.d("ðŸŽ¯ CALLBACK INVOKED! Count=$callbackInvokedCount, result=${if (result == null) "null" else "FOUND"}")
                                
                                if (result == null) {
                                    nullResultCount++
                                    val now = System.currentTimeMillis()
                                    if (now - lastLogTime > 2000) {
                                        Timber.d("ðŸ“¸ Scanning... callbacks=$callbackInvokedCount, null=$nullResultCount")
                                        lastLogTime = now
                                    }
                                } else {
                                    Timber.i("âœ“âœ“âœ“ QR CODE DECODED SUCCESSFULLY âœ“âœ“âœ“")
                                    Timber.i("Text: ${result.text}")
                                    Timber.i("Format: ${result.barcodeFormat}")
                                    pause()
                                    onQrCodeScanned(result.text)
                                }
                            }
                            
                            override fun possibleResultPoints(resultPoints: MutableList<com.google.zxing.ResultPoint>?) {
                                if (resultPoints != null && resultPoints.isNotEmpty()) {
                                    Timber.w("âš ï¸ Pattern: ${resultPoints.size} points")
                                }
                            }
                        }
                        
                        // Start camera FIRST, register callback AFTER preview is ready
                        Timber.i("Starting camera preview...")
                        resume()
                        Timber.i("âœ“ Camera started, waiting for preview to stabilize...")
                        
                        // Register callback AFTER camera has fully initialized
                        postDelayed({
                            Timber.i("Preview ready: $isPreviewActive - NOW registering callback...")
                            decodeContinuous(callback)
                            Timber.i("âœ“ Callback registered via decodeContinuous()")
                            
                            // Check if callbacks start firing
                            postDelayed({
                                Timber.i("Check at +2s: callbacks=$callbackInvokedCount")
                                if (callbackInvokedCount == 0) {
                                    Timber.e("âŒ STILL NO CALLBACKS - decoder not working")
                                    Timber.e("Library version may be incompatible or requires different initialization")
                                } else {
                                    Timber.i("âœ… Decoder is working! ($callbackInvokedCount callbacks)")
                                }
                            }, 2000)
                        }, 1000)
                    }
                },
                modifier = Modifier.fillMaxSize(),
                update = { view ->
                    // Ensure camera is active when view updates
                    if (!view.isPreviewActive) {
                        Timber.w("Preview not active, resuming...")
                        view.resume()
                    }
                },
                onRelease = { view ->
                    Timber.i("Releasing camera view")
                    view.pause()
                }
            )
            
            // Overlay with instructions and close button
            Column(
                modifier = Modifier
                    .fillMaxWidth()
                    .align(Alignment.TopCenter)
                    .padding(16.dp),
                horizontalAlignment = Alignment.CenterHorizontally
            ) {
                Card(
                    colors = CardDefaults.cardColors(
                        containerColor = MaterialTheme.colorScheme.surface.copy(alpha = 0.9f)
                    )
                ) {
                    Column(
                        modifier = Modifier.padding(16.dp),
                        horizontalAlignment = Alignment.CenterHorizontally
                    ) {
                        Text(
                            text = "Scan QR Code",
                            style = MaterialTheme.typography.titleMedium
                        )
                        Spacer(modifier = Modifier.height(4.dp))
                        Text(
                            text = "Position the QR code within the frame",
                            style = MaterialTheme.typography.bodySmall,
                            color = MaterialTheme.colorScheme.onSurfaceVariant
                        )
                    }
                }
            }
            
            // Cancel button at bottom
            FilledTonalButton(
                onClick = onDismiss,
                modifier = Modifier
                    .align(Alignment.BottomCenter)
                    .padding(16.dp)
            ) {
                Text("Cancel")
            }
        }
    } else {
        // Permission denied or waiting
        Box(
            modifier = Modifier.fillMaxSize(),
            contentAlignment = Alignment.Center
        ) {
            Column(horizontalAlignment = Alignment.CenterHorizontally) {
                Text("Camera permission is required to scan QR codes")
                Spacer(modifier = Modifier.height(16.dp))
                Button(onClick = onDismiss) {
                    Text("Close")
                }
            }
        }
    }
}
